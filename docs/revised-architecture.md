# Knowledge Base システムアーキテクチャ設計（改訂版）

## 概要

レビューコメントを反映し、`gh`コマンドとClaude CLIを活用することで、より簡潔で柔軟な設計に変更しました。

## 改訂版システム構成

### 主要コンポーネント

```
┌─────────────────────────────────────────────────────────────┐
│                     Knowledge Base System                    │
├─────────────────────────┬───────────────────────────────────┤
│                         │                                   │
│    Data Collector       │      Knowledge Manager            │
│   ┌─────────────┐     │    ┌──────────────────┐         │
│   │ GH Wrapper  │     │    │ Document Store   │         │
│   └──────┬──────┘     │    └────────┬─────────┘         │
│          │             │             │                     │
│   ┌──────▼──────┐     │    ┌────────▼─────────┐         │
│   │ PR Parser   │     │    │ Query Engine     │         │
│   └──────┬──────┘     │    └────────┬─────────┘         │
│          │             │             │                     │
│   ┌──────▼──────┐     │    ┌────────▼─────────┐         │
│   │ LLM Driver  │     │    │ Context Builder  │         │
│   └──────┬──────┘     │    └────────┬─────────┘         │
│          │             │             │                     │
├──────────┼─────────────┴─────────────┼─────────────────────┤
│          ▼                           ▼                     │
│       ┌─────────────────────────────────┐                 │
│       │        SQLite Database          │                 │
│       └─────────────────────────────────┘                 │
├─────────────────────────────────────────────────────────────┤
│                    External Commands                        │
│  ┌──────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │    gh    │    │  claude -p  │    │  gemini -p  │      │
│  └──────────┘    └─────────────┘    └─────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 改訂されたコンポーネント説明

#### 1. Data Collector
PR収集と分析を担当するコンポーネント群

- **GH Wrapper**: `gh`コマンドのラッパー
  - APIトークン管理が不要（ghの認証を利用）
  - JSONフォーマットでの出力を解析
  - より簡潔なエラーハンドリング
  
- **PR Parser**: 取得したPRデータから必要な情報を抽出
  - ghコマンドの出力を解析
  - スレッド単位でのコメント整理
  
- **LLM Driver**: 外部LLMコマンドの実行管理
  - claude, gemini等のCLIを並列実行
  - プロンプトテンプレート管理
  - 結果の集約

#### 2. Knowledge Manager
（変更なし）

## 技術スタックの変更

### 外部依存の削減
- ~~`github.com/google/go-github/v58`~~ → `gh`コマンド
- ~~`github.com/sashabaranov/go-openai`~~ → `claude -p`, `gemini -p`等

### 新しい依存関係
- `os/exec`: 外部コマンド実行
- `encoding/json`: コマンド出力の解析
- 並列処理用の標準ライブラリのみ

## 主な利点

### 1. 認証の簡素化
- ghコマンドの認証機構を利用
- APIトークンの管理不要
- より安全（トークンがコード内に存在しない）

### 2. LLMの柔軟性
- 複数のLLMを簡単に切り替え可能
- 並列実行による高速化
- 新しいLLMの追加が容易

### 3. 実装の簡素化
- 外部ライブラリの依存を最小化
- エラーハンドリングがシンプル
- デバッグが容易（コマンドを直接実行可能）

## セキュリティ上の利点

- APIキーやトークンをコード内で管理する必要がない
- 各CLIツールの認証機構を利用
- 環境変数の露出リスクを削減