# Knowledge Base システムアーキテクチャ設計

## 概要

Knowledge Baseシステムは、過去のPull Requestレビューコメントを収集・分析し、AIがコード生成やレビューを行う際のコンテキストとして活用できるようにするツールです。

## システム構成

### 主要コンポーネント

```
┌─────────────────────────────────────────────────────────────┐
│                     Knowledge Base System                    │
├─────────────────────────┬───────────────────────────────────┤
│                         │                                   │
│    Data Collector       │      Knowledge Manager            │
│   ┌─────────────┐     │    ┌──────────────────┐         │
│   │ PR Fetcher  │     │    │ Document Store   │         │
│   └──────┬──────┘     │    └────────┬─────────┘         │
│          │             │             │                     │
│   ┌──────▼──────┐     │    ┌────────▼─────────┐         │
│   │ PR Parser   │     │    │ Query Engine     │         │
│   └──────┬──────┘     │    └────────┬─────────┘         │
│          │             │             │                     │
│   ┌──────▼──────┐     │    ┌────────▼─────────┐         │
│   │ LLM Analyzer│     │    │ Context Builder  │         │
│   └──────┬──────┘     │    └────────┬─────────┘         │
│          │             │             │                     │
├──────────┼─────────────┴─────────────┼─────────────────────┤
│          ▼                           ▼                     │
│       ┌─────────────────────────────────┐                 │
│       │        SQLite Database          │                 │
│       └─────────────────────────────────┘                 │
└─────────────────────────────────────────────────────────────┘
```

### コンポーネント説明

#### 1. Data Collector
PR収集と分析を担当するコンポーネント群

- **PR Fetcher**: GitHub APIを使用してPull Requestとレビューコメントを取得
  - 効率的な収集のため、最新のPRから遡って取得
  - レート制限を考慮した実装
  
- **PR Parser**: 取得したPRデータから必要な情報を抽出
  - レビューコメントのスレッド単位での抽出
  - ファイルパス、言語、コメント位置の特定
  
- **LLM Analyzer**: コメントの分析とメタデータ生成
  - コメントの要約と分類
  - メタデータの自動タグ付け

#### 2. Knowledge Manager
ナレッジの管理と提供を担当するコンポーネント群

- **Document Store**: ドキュメントの永続化管理
  - SQLiteへのCRUD操作
  - インデックス管理
  
- **Query Engine**: 検索クエリの処理
  - ファイル名、ディレクトリ、言語での検索
  - 関連度スコアリング
  
- **Context Builder**: AI用コンテキストの構築
  - 関連ドキュメントの選択
  - プロンプト用フォーマット生成

### データフロー

1. **収集フェーズ**
   ```
   GitHub API → PR Fetcher → PR Parser → LLM Analyzer → SQLite
   ```

2. **利用フェーズ**
   ```
   クエリ → Query Engine → Document Store → Context Builder → AIコンテキスト
   ```

## 技術スタック

### 言語・フレームワーク
- **言語**: Go 1.21+
- **Webフレームワーク**: net/http（標準ライブラリ）
- **データベース**: SQLite3

### 主要ライブラリ
- `github.com/google/go-github/v58`: GitHub API クライアント
- `github.com/mattn/go-sqlite3`: SQLiteドライバ
- `github.com/sashabaranov/go-openai`: OpenAI API クライアント（LLM分析用）

### 設計原則

1. **シンプルさ優先**
   - PoCとして必要最小限の機能に絞る
   - 複雑な依存関係を避ける

2. **拡張性の確保**
   - インターフェースベースの設計
   - 将来的な機能追加を考慮

3. **ローカル完結**
   - 外部サービスへの依存を最小限に
   - オフラインでも動作可能な設計

## エラーハンドリング

### API制限対策
- GitHub APIのレート制限に対応
- リトライ機構の実装
- 部分的な失敗を許容する設計

### データ整合性
- トランザクション管理
- 重複データの検出と処理
- 不完全なデータの扱い

## セキュリティ考慮事項

- GitHub トークンの安全な管理
- LLM APIキーの保護
- センシティブな情報のフィルタリング